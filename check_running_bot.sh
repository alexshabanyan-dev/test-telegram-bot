#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –±–æ—Ç–∞

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å
PID=$(pgrep -f "python.*main.py" | head -1)

if [ -z "$PID" ]; then
    echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞–π–¥–µ–Ω: PID=$PID"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å):"
sudo journalctl _PID=$PID -n 20 --no-pager 2>/dev/null || echo "   –õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π
echo "üìÅ –§–∞–π–ª—ã —Å–µ—Å—Å–∏–π:"
ls -lh ~/test-telegram-bot/*.session* 2>/dev/null
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –±–∞–∑–∞
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:"
lsof ~/test-telegram-bot/*.session* 2>/dev/null || echo "   –§–∞–π–ª—ã –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏"
echo ""

echo "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:"
echo "   1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç: sudo systemctl stop telegram-monitor.service"
echo "   2. –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: rm -f ~/test-telegram-bot/*.session-journal"
echo "   3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: bash fix_session_lock.sh"
echo "   4. –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: python main.py"
